# =============================================================================
# REUSABLE WORKFLOW: Release
# =============================================================================
# Called by consuming repos to perform secure, auditable releases.
# Uses OIDC for authentication‚Äîno static secrets required.
#
# Usage from app repo:
#   jobs:
#     release:
#       uses: mgmacri/OP_Client-Companion-Governance/.github/workflows/release.yml@main
#       with:
#         environment: production
#         node-version: "20"
#       permissions:
#         id-token: write
#         contents: write
# =============================================================================

name: Release (Reusable)

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version to use"
        required: false
        type: string
        default: "20"
      pnpm-version:
        description: "pnpm version to use"
        required: false
        type: string
        default: "9"
      working-directory:
        description: "Working directory for the app"
        required: false
        type: string
        default: "."
      environment:
        description: "Deployment environment (staging, production)"
        required: true
        type: string
      dry-run:
        description: "Perform a dry run without publishing"
        required: false
        type: boolean
        default: false
      create-github-release:
        description: "Create a GitHub release with changelog"
        required: false
        type: boolean
        default: true
    outputs:
      version:
        description: "The released version number"
        value: ${{ jobs.release.outputs.version }}
      release-url:
        description: "URL to the GitHub release"
        value: ${{ jobs.release.outputs.release-url }}

# OIDC permissions for cloud authentication
permissions:
  id-token: write
  contents: write
  packages: write
  attestations: write

jobs:
  # ---------------------------------------------------------------------------
  # Pre-Release Validation
  # ---------------------------------------------------------------------------
  validate:
    name: Pre-Release Validation
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Validate branch
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          if [[ "${{ inputs.environment }}" == "production" && "$BRANCH" != "main" ]]; then
            echo "‚ùå Production releases must be from 'main' branch"
            exit 1
          fi
          echo "‚úÖ Branch validation passed: $BRANCH"

      - name: Validate no breaking compliance changes
        run: |
          echo "::group::Compliance validation"
          # Ensure critical compliance files haven't been removed
          REQUIRED_FILES=(
            ".github/copilot-instructions.md"
          )
          for file in "${REQUIRED_FILES[@]}"; do
            if [[ -f "$file" ]]; then
              echo "‚úÖ $file exists"
            else
              echo "‚ö†Ô∏è Optional governance file missing: $file"
            fi
          done
          echo "::endgroup::"

  # ---------------------------------------------------------------------------
  # Build
  # ---------------------------------------------------------------------------
  build:
    name: Build
    needs: validate
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node + pnpm
        uses: mgmacri/OP_Client-Companion-Governance/.github/actions/setup-node-pnpm@main
        with:
          node-version: ${{ inputs.node-version }}
          pnpm-version: ${{ inputs.pnpm-version }}
          working-directory: ${{ inputs.working-directory }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: build-artifacts
          path: |
            ${{ inputs.working-directory }}/dist
            ${{ inputs.working-directory }}/build
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Release
  # ---------------------------------------------------------------------------
  release:
    name: Release
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      version: ${{ steps.version.outputs.version }}
      release-url: ${{ steps.create-release.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ github.token }}

      - name: Download build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: build-artifacts
          path: ${{ inputs.working-directory }}/dist

      - name: Determine version
        id: version
        run: |
          # Extract version from package.json or use git tag
          if [[ -f "${{ inputs.working-directory }}/package.json" ]]; then
            VERSION=$(jq -r '.version' "${{ inputs.working-directory }}/package.json")
          else
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "üì¶ Version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Generate changelog from conventional commits
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [[ -n "$LAST_TAG" ]]; then
            CHANGELOG=$(git log "$LAST_TAG"..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi
          echo "changelog<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHANGELOG" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        id: create-release
        if: ${{ inputs.create-github-release && !inputs.dry-run }}
        uses: actions/create-release@0cb9c9b65d5d1901c1f53e5e66eaf4afd303e70e # v1.1.4
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: Release v${{ steps.version.outputs.version }}
          body: |
            ## Changes
            
            ${{ steps.changelog.outputs.changelog }}
            
            ---
            
            **Environment:** ${{ inputs.environment }}
            **Commit:** ${{ github.sha }}
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          draft: false
          prerelease: ${{ inputs.environment != 'production' }}

      - name: Dry run summary
        if: ${{ inputs.dry-run }}
        run: |
          echo "üîç DRY RUN - No release created"
          echo "Would release version: ${{ steps.version.outputs.version }}"
          echo "Environment: ${{ inputs.environment }}"

  # ---------------------------------------------------------------------------
  # Attestation (SLSA Provenance)
  # ---------------------------------------------------------------------------
  attestation:
    name: Generate Attestation
    needs: release
    if: ${{ !inputs.dry-run }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Download build artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: build-artifacts
          path: ./dist

      - name: Generate SLSA provenance
        uses: actions/attest-build-provenance@1c608d11d69870c2092266b3f9a6f3abbf17002c # v1.4.3
        with:
          subject-path: ./dist/**/*

      - name: Audit log entry
        run: |
          echo "üìã Release Audit Log"
          echo "===================="
          echo "Version: ${{ needs.release.outputs.version }}"
          echo "Environment: ${{ inputs.environment }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
