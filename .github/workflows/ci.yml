# =============================================================================
# REUSABLE WORKFLOW: Continuous Integration
# =============================================================================
# Core CI workflow for build and test. Can be called directly or used as base.
# For PR-specific checks, use pr-check.yml which includes additional gates.
#
# Usage from app repo:
#   jobs:
#     ci:
#       uses: ORG/owl-governance/.github/workflows/ci.yml@main
#       with:
#         node-version: "20"
#         working-directory: "app/client-companion"
# =============================================================================

name: CI (Reusable)

on:
  # Direct triggers for this repo
  push:
    branches:
      - main
      - develop
  pull_request:
  workflow_dispatch:
  
  # Reusable workflow trigger
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version to use"
        required: false
        type: string
        default: "20"
      pnpm-version:
        description: "pnpm version to use"
        required: false
        type: string
        default: "9"
      working-directory:
        description: "Working directory for the app"
        required: false
        type: string
        default: "."
      run-build:
        description: "Run build step"
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  # ---------------------------------------------------------------------------
  # Build & Test
  # ---------------------------------------------------------------------------
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory || '.' }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      # Setup Node (initial, no pnpm yet)
      - name: Setup Node
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: ${{ inputs.node-version || '20' }}

      # Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703c70f43f2f5c4ad23e239937 # v4.0.0
        with:
          version: ${{ inputs.pnpm-version || '9' }}
          run_install: false

      # Get pnpm store directory for caching
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> "$GITHUB_OUTPUT"

      # Setup pnpm cache
      - name: Setup pnpm cache
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # Setup Node with pnpm cache
      - name: Setup Node (with pnpm cache)
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: ${{ inputs.node-version || '20' }}
          cache: pnpm
          cache-dependency-path: ${{ inputs.working-directory || '.' }}/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Test
        run: pnpm test -- --ci

      - name: Build
        if: ${{ inputs.run-build != false }}
        run: pnpm build
