%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'primaryTextColor': '#fff', 'primaryBorderColor': '#2d6cb5', 'lineColor': '#5c6bc0', 'secondaryColor': '#81c784', 'tertiaryColor': '#fff3e0'}}}%%

flowchart TB
    subgraph ClientLayer["üñ•Ô∏è Client Layer"]
        direction TB
        
        subgraph MobileApp["React Native<br/>(Mobile App)"]
            MoodForm["Mood Diary Form"]
            CBTForm["CBT Thought Record"]
            SleepForm["Sleep Log"]
            OtherForms["Other Log Forms..."]
        end
        
        subgraph WebApp["React Web<br/>(Therapist Portal)"]
            PendingReview["Pending Review Queue"]
            NoteApproval["Note Approval UI"]
            ClientList["Client Dashboard"]
        end
        
        subgraph StateManagement["Redux + Saga"]
            LogFormSlice["logFormSlice"]
            ConsentState["Consent State"]
            QueueSyncSaga["queueSyncSaga"]
        end
        
        ConsentGate{{"üîí Consent Gate<br/>Required before submit"}}
        
        MoodForm --> ConsentGate
        CBTForm --> ConsentGate
        SleepForm --> ConsentGate
        OtherForms --> ConsentGate
        
        ConsentGate --> LogFormSlice
        LogFormSlice --> QueueSyncSaga
    end
    
    subgraph OfflineQueue["üì¶ Offline Encrypted Queue"]
        direction LR
        Queue["Local Queue<br/>(Max 50 items)"]
        Encryption["üîê Device Encryption"]
        Queue --> Encryption
    end
    
    QueueSyncSaga --> OfflineQueue
    
    subgraph SyncLayer["üîÑ Sync Layer"]
        ConnectivityCheck{"Online?"}
        RetryLogic["Retry with Backoff"]
    end
    
    OfflineQueue --> ConnectivityCheck
    ConnectivityCheck -->|No| RetryLogic
    RetryLogic --> ConnectivityCheck
    
    subgraph BackendLayer["‚öôÔ∏è Backend Layer"]
        direction TB
        
        subgraph API["REST API"]
            PostLogs["POST /api/logs"]
            GetLogs["GET /api/logs"]
            DraftNotes["POST /api/draft-notes"]
        end
        
        subgraph Processing["Deterministic Processing"]
            TemplateEngine["Template-Based<br/>Note Synthesis"]
            Validation["Schema Validation"]
            TimestampUTC["submitted_at_utc<br/>(Server-Set)"]
        end
        
        subgraph Storage["SQL Storage"]
            ClientLogEntry[("ClientLogEntry")]
            DraftNote[("DraftNote<br/>status: pending_review")]
            AuditLog[("Audit Log")]
        end
        
        PostLogs --> Validation
        Validation --> TimestampUTC
        TimestampUTC --> ClientLogEntry
        ClientLogEntry --> TemplateEngine
        TemplateEngine --> DraftNote
        
        GetLogs --> ClientLogEntry
    end
    
    ConnectivityCheck -->|Yes| API
    API --> WebApp
    
    %% Styling
    classDef clientBox fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef backendBox fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef queueBox fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef syncBox fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef consentNode fill:#ffcdd2,stroke:#d32f2f,stroke-width:2px
    classDef storageNode fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px
    
    class ClientLayer clientBox
    class BackendLayer backendBox
    class OfflineQueue queueBox
    class SyncLayer syncBox
    class ConsentGate consentNode
    class ClientLogEntry,DraftNote,AuditLog storageNode
