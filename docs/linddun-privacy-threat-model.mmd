%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#6f42c1', 'primaryTextColor': '#fff', 'primaryBorderColor': '#5a32a3', 'lineColor': '#6c757d', 'secondaryColor': '#20c997', 'tertiaryColor': '#e83e8c'}}}%%

flowchart TB
    subgraph Title["ğŸ” LINDDUN Privacy Threat Model - Mental Health Client Companion"]
        direction TB
    end

    subgraph Legend["ğŸ“š LINDDUN Categories"]
        direction LR
        L["ğŸ”— L - Linkability<br/>Correlating data"]
        I["ğŸ‘¤ I - Identifiability<br/>Identifying subjects"]
        NR["ğŸš« NR - Non-Repudiation<br/>Cannot deny actions"]
        De["ğŸ” De - Detectability<br/>Existence inference"]
        Di["ğŸ“¤ Di - Disclosure<br/>Information exposure"]
        U["â“ U - Unawareness<br/>Lack of transparency"]
        NC["âš–ï¸ NC - Non-Compliance<br/>Regulatory violations"]
    end

    subgraph DataSubjects["ğŸ‘¥ Data Subjects & PHI Types"]
        direction TB
        
        Client["ğŸ‘¤ Client (Patient)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>PHI Collected:<br/>â€¢ Mood ratings (1-10)<br/>â€¢ Emotions & triggers<br/>â€¢ CBT thought records<br/>â€¢ Sleep patterns<br/>â€¢ Anxiety episodes<br/>â€¢ Safety notes"]
        
        Therapist["ğŸ‘¨â€âš•ï¸ Therapist<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Data Collected:<br/>â€¢ Professional credentials<br/>â€¢ Client interactions<br/>â€¢ Review timestamps<br/>â€¢ Approval decisions"]
    end

    subgraph LinkabilityThreats["ğŸ”— LINKABILITY THREATS"]
        direction TB
        
        L1["L1 - Cross-Log Correlation<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Link mood entries to<br/>sleep logs to CBT records<br/>to build behavioral profile<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: HIGH<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Purpose limitation (G3)<br/>â€¢ Separate access controls<br/>â€¢ Data minimization"]
        
        L2["L2 - Therapist-Client Linking<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Infer therapeutic<br/>relationships from access<br/>patterns<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: MEDIUM<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Access log protection<br/>â€¢ Aggregate reporting only<br/>â€¢ Time-delayed analytics"]
        
        L3["L3 - Device Fingerprinting<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Track user across<br/>sessions via device ID<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: MEDIUM<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Rotating device tokens<br/>â€¢ No persistent identifiers<br/>â€¢ Privacy-preserving auth"]
        
        L4["L4 - Temporal Correlation<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Link entries via<br/>logged_at_local timestamps<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: LOW<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Timestamp rounding<br/>â€¢ Batch submissions<br/>â€¢ Noise injection"]
    end

    subgraph IdentifiabilityThreats["ğŸ‘¤ IDENTIFIABILITY THREATS"]
        direction TB
        
        I1["I1 - Direct Identification<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Client ID in logs<br/>directly identifies patient<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: CRITICAL<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Pseudonymization (G11)<br/>â€¢ UUID vs natural keys<br/>â€¢ Key separation"]
        
        I2["I2 - Quasi-Identifier Attack<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Combine mood + sleep +<br/>location to re-identify<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: HIGH<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ k-anonymity for exports<br/>â€¢ Generalization<br/>â€¢ No location collection"]
        
        I3["I3 - Free-Text Re-identification<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Notes/triggers contain<br/>identifying information<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: HIGH<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ NER-based scrubbing<br/>â€¢ User education<br/>â€¢ Therapist review gate"]
        
        I4["I4 - Metadata Identification<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: IP address, user-agent<br/>in access logs<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: MEDIUM<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ IP anonymization<br/>â€¢ Minimal logging<br/>â€¢ Log retention limits"]
    end

    subgraph NonRepudiationThreats["ğŸš« NON-REPUDIATION THREATS"]
        direction TB
        
        NR1["NR1 - Undeniable Mental State<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Client cannot deny<br/>recorded mood/anxiety states<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: HIGH<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Context: May be required<br/>for clinical validity<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Balance:<br/>â€¢ Consent explains permanence<br/>â€¢ Correction rights (G5)<br/>â€¢ Retention limits (G8)"]
        
        NR2["NR2 - Consent Non-Repudiation<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Immutable consent<br/>record proves agreement<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: MEDIUM<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Context: Required for<br/>legal compliance<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Balance:<br/>â€¢ Clear consent language<br/>â€¢ Withdrawal capability<br/>â€¢ Version tracking"]
        
        NR3["NR3 - Therapist Activity Proof<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Audit logs prove<br/>therapist access patterns<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: MEDIUM<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Balance:<br/>â€¢ Professional necessity<br/>â€¢ Access to own logs<br/>â€¢ Proportionate retention"]
    end

    subgraph DetectabilityThreats["ğŸ” DETECTABILITY THREATS"]
        direction TB
        
        De1["De1 - Existence Inference<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Infer someone uses<br/>mental health app from<br/>network traffic patterns<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: HIGH<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Traffic padding<br/>â€¢ Generic API endpoints<br/>â€¢ CDN/proxy obfuscation"]
        
        De2["De2 - Treatment Detection<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Frequency of entries<br/>reveals treatment intensity<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: MEDIUM<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Dummy traffic generation<br/>â€¢ Batch sync windows<br/>â€¢ Encrypted sync metadata"]
        
        De3["De3 - Crisis Detection<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Spike in submissions<br/>indicates crisis episode<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: HIGH<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Rate limiting hides spikes<br/>â€¢ Queue smoothing<br/>â€¢ End-to-end encryption"]
    end

    subgraph DisclosureThreats["ğŸ“¤ DISCLOSURE OF INFORMATION"]
        direction TB
        
        Di1["Di1 - Unauthorized PHI Access<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Breach exposes<br/>mood/CBT/sleep records<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: CRITICAL<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Encryption at rest (G6)<br/>â€¢ Access controls (G4)<br/>â€¢ Breach response (G7)"]
        
        Di2["Di2 - Insider Threat<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Employee/admin<br/>accesses client records<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: CRITICAL<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Need-to-know access<br/>â€¢ Audit logging (G15)<br/>â€¢ Background checks"]
        
        Di3["Di3 - Third-Party Disclosure<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Cloud provider or<br/>subprocessor accesses data<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: HIGH<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ DPA agreements (G9)<br/>â€¢ Encryption key control<br/>â€¢ Canadian data residency (G10)"]
        
        Di4["Di4 - Analytics Leakage<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Aggregate reports<br/>reveal individual patterns<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: MEDIUM<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Differential privacy<br/>â€¢ Minimum group sizes<br/>â€¢ De-identification (G11)"]
    end

    subgraph UnawarenessThreats["â“ UNAWARENESS THREATS"]
        direction TB
        
        U1["U1 - Opaque Data Processing<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Client unaware how<br/>their PHI is processed<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: HIGH<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Clear privacy notice (G2)<br/>â€¢ Purpose specification (G3)<br/>â€¢ Layered consent UI"]
        
        U2["U2 - Hidden Data Collection<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Metadata collected<br/>without explicit notice<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: MEDIUM<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Complete data inventory (G1)<br/>â€¢ Transparent collection<br/>â€¢ Consent for all data types"]
        
        U3["U3 - Unknown Retention<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Client doesn't know<br/>how long data is kept<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: MEDIUM<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Published retention policy (G8)<br/>â€¢ Deletion confirmation<br/>â€¢ Retention reminders"]
        
        U4["U4 - Access Unawareness<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Client unaware who<br/>has accessed their records<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: MEDIUM<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Access notification<br/>â€¢ Disclosure accounting (G5)<br/>â€¢ Audit log access"]
    end

    subgraph NonComplianceThreats["âš–ï¸ NON-COMPLIANCE THREATS"]
        direction TB
        
        NC1["NC1 - Provincial PHI Violations<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Fail to meet PHIPA,<br/>HIA, PHIA requirements<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: CRITICAL<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Compliance gates (G1-G17)<br/>â€¢ Legal review<br/>â€¢ Regular audits"]
        
        NC2["NC2 - Cross-Border Violations<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Data stored/processed<br/>outside Canada without<br/>proper safeguards<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: HIGH<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Canadian data residency (G10)<br/>â€¢ Adequacy assessments<br/>â€¢ Consent for transfers"]
        
        NC3["NC3 - Consent Deficiencies<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Invalid or incomplete<br/>consent for PHI processing<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: CRITICAL<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Consent validation (G2)<br/>â€¢ Version tracking<br/>â€¢ Re-consent workflows"]
        
        NC4["NC4 - Rights Violations<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Threat: Fail to honor access,<br/>correction, deletion requests<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Privacy Impact: HIGH<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Rights portal (G5)<br/>â€¢ SLA for responses<br/>â€¢ Automated workflows"]
    end

    subgraph DataFlowPrivacy["ğŸ”„ Privacy in Data Flow"]
        direction LR
        
        Collection["ğŸ“ Collection<br/>â”â”â”â”â”â”â”â”â”â”â”<br/>Risks: U1, U2, NC3<br/>Controls: G1, G2, G3"]
        
        Processing["âš™ï¸ Processing<br/>â”â”â”â”â”â”â”â”â”â”â”<br/>Risks: L1, I3, De2<br/>Controls: G4, G11"]
        
        Storage["ğŸ’¾ Storage<br/>â”â”â”â”â”â”â”â”â”â”â”<br/>Risks: Di1, Di2, I1<br/>Controls: G6, G8"]
        
        Disclosure["ğŸ“¤ Disclosure<br/>â”â”â”â”â”â”â”â”â”â”â”<br/>Risks: Di3, NC2, L2<br/>Controls: G4, G9, G10"]
        
        Collection --> Processing
        Processing --> Storage
        Storage --> Disclosure
    end

    %% Connect subjects to threats
    Client --> LinkabilityThreats
    Client --> IdentifiabilityThreats
    Client --> UnawarenessThreats
    Therapist --> NonRepudiationThreats
    
    LinkabilityThreats --> DataFlowPrivacy
    IdentifiabilityThreats --> DataFlowPrivacy
    DetectabilityThreats --> DataFlowPrivacy
    DisclosureThreats --> DataFlowPrivacy
    NonComplianceThreats --> DataFlowPrivacy

    %% Styling
    classDef linkability fill:#6f42c1,stroke:#5a32a3,stroke-width:2px,color:#fff
    classDef identifiability fill:#e83e8c,stroke:#c22d73,stroke-width:2px,color:#fff
    classDef nonrepudiation fill:#fd7e14,stroke:#c96209,stroke-width:2px,color:#fff
    classDef detectability fill:#20c997,stroke:#19a07a,stroke-width:2px,color:#fff
    classDef disclosure fill:#dc3545,stroke:#a71d2a,stroke-width:2px,color:#fff
    classDef unawareness fill:#0dcaf0,stroke:#0aa2c0,stroke-width:2px,color:#000
    classDef noncompliance fill:#6c757d,stroke:#545b62,stroke-width:2px,color:#fff
    classDef dataflow fill:#198754,stroke:#146c43,stroke-width:2px,color:#fff
    classDef subject fill:#fff3cd,stroke:#ffc107,stroke-width:2px,color:#000
    classDef legend fill:#f8f9fa,stroke:#dee2e6,stroke-width:1px

    class L1,L2,L3,L4,LinkabilityThreats linkability
    class I1,I2,I3,I4,IdentifiabilityThreats identifiability
    class NR1,NR2,NR3,NonRepudiationThreats nonrepudiation
    class De1,De2,De3,DetectabilityThreats detectability
    class Di1,Di2,Di3,Di4,DisclosureThreats disclosure
    class U1,U2,U3,U4,UnawarenessThreats unawareness
    class NC1,NC2,NC3,NC4,NonComplianceThreats noncompliance
    class Collection,Processing,Storage,Disclosure,DataFlowPrivacy dataflow
    class Client,Therapist,DataSubjects subject
    class Legend,L,I,NR,De,Di,U,NC legend
