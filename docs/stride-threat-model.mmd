%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#dc3545', 'primaryTextColor': '#fff', 'primaryBorderColor': '#a71d2a', 'lineColor': '#6c757d', 'secondaryColor': '#ffc107', 'tertiaryColor': '#17a2b8'}}}%%

flowchart TB
    subgraph Title["ğŸ›¡ï¸ STRIDE Threat Model - Mental Health Client Companion"]
        direction TB
    end

    subgraph Legend["ğŸ“š STRIDE Categories"]
        direction LR
        S["ğŸ­ S - Spoofing<br/>Identity threats"]
        T["âœï¸ T - Tampering<br/>Data integrity"]
        R["ğŸ“ R - Repudiation<br/>Audit/accountability"]
        I["ğŸ”“ I - Information Disclosure<br/>Confidentiality"]
        D["â›” D - Denial of Service<br/>Availability"]
        E["â¬†ï¸ E - Elevation of Privilege<br/>Authorization"]
    end

    subgraph ClientLayer["ğŸ–¥ï¸ Client Layer Attack Surface"]
        direction TB
        
        subgraph S1["ğŸ­ SPOOFING THREATS"]
            S1_1["S1.1 - Session Hijacking<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Steal JWT tokens from<br/>localStorage/memory<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ HttpOnly secure cookies<br/>â€¢ Token rotation<br/>â€¢ Device fingerprinting"]
            
            S1_2["S1.2 - Client Impersonation<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Fake mobile app<br/>submits malicious data<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ App attestation (Play Integrity)<br/>â€¢ Certificate pinning<br/>â€¢ Client-side integrity checks"]
            
            S1_3["S1.3 - Therapist Impersonation<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Attacker poses as<br/>licensed therapist<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Credential verification (G16)<br/>â€¢ MFA enforcement<br/>â€¢ Regulatory body validation"]
        end
        
        subgraph T1["âœï¸ TAMPERING THREATS"]
            T1_1["T1.1 - Local Queue Manipulation<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Modify encrypted<br/>IndexedDB entries<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ AES-256-GCM encryption<br/>â€¢ HMAC integrity verification<br/>â€¢ Server-side validation"]
            
            T1_2["T1.2 - Form Data Injection<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: XSS/injection via<br/>mood diary fields<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Input sanitization<br/>â€¢ CSP headers<br/>â€¢ Schema validation (AJV)"]
            
            T1_3["T1.3 - Consent Record Tampering<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Modify consent<br/>timestamps or status<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Immutable consent log<br/>â€¢ Server-authoritative timestamps<br/>â€¢ Blockchain anchoring (future)"]
        end
    end

    subgraph TransportLayer["ğŸ”„ Transport Layer Attack Surface"]
        direction TB
        
        subgraph I1["ğŸ”“ INFORMATION DISCLOSURE"]
            I1_1["I1.1 - Man-in-the-Middle<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Intercept PHI during<br/>sync to backend<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ TLS 1.3 mandatory<br/>â€¢ Certificate pinning<br/>â€¢ HSTS preloading"]
            
            I1_2["I1.2 - API Response Leakage<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Error messages<br/>expose sensitive data<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Sanitized error responses<br/>â€¢ No stack traces in production<br/>â€¢ Generic error codes"]
            
            I1_3["I1.3 - Metadata Exposure<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: HTTP headers reveal<br/>client/therapist patterns<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Minimal headers<br/>â€¢ Padding/timing normalization<br/>â€¢ Traffic analysis resistance"]
        end
        
        subgraph D1["â›” DENIAL OF SERVICE"]
            D1_1["D1.1 - API Rate Exhaustion<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Flood POST /api/logs<br/>with fake submissions<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Rate limiting per client<br/>â€¢ Queue depth limits (50 max)<br/>â€¢ WAF protection"]
            
            D1_2["D1.2 - Offline Queue Overflow<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Fill local queue to<br/>prevent legitimate entries<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ 50 item queue limit<br/>â€¢ FIFO eviction policy<br/>â€¢ User notification on full"]
            
            D1_3["D1.3 - Sync Storm<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Trigger mass reconnect<br/>to overwhelm backend<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Exponential backoff<br/>â€¢ Jittered retry timing<br/>â€¢ Circuit breaker pattern"]
        end
    end

    subgraph BackendLayer["âš™ï¸ Backend Layer Attack Surface"]
        direction TB
        
        subgraph R1["ğŸ“ REPUDIATION THREATS"]
            R1_1["R1.1 - Log Entry Denial<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Client claims they<br/>never submitted entry<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Signed queue entries<br/>â€¢ Consent audit trail (G15)<br/>â€¢ Non-repudiable timestamps"]
            
            R1_2["R1.2 - Therapist Action Denial<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Therapist denies<br/>approving/viewing notes<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Immutable audit log<br/>â€¢ Actor identification<br/>â€¢ Session recording"]
            
            R1_3["R1.3 - Admin Privilege Abuse<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Admin modifies<br/>records without trace<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Separate audit DB<br/>â€¢ Dual-control for changes<br/>â€¢ SIEM integration"]
        end
        
        subgraph E1["â¬†ï¸ ELEVATION OF PRIVILEGE"]
            E1_1["E1.1 - RBAC Bypass<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Client accesses<br/>therapist-only endpoints<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ JWT role claims<br/>â€¢ Server-side RBAC checks<br/>â€¢ Principle of least privilege"]
            
            E1_2["E1.2 - Cross-Client Access<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Client A reads<br/>Client B's mood entries<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Row-level security<br/>â€¢ Client ID in JWT<br/>â€¢ Query parameterization"]
            
            E1_3["E1.3 - JWT Token Forgery<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Craft token with<br/>elevated privileges<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ RS256 asymmetric signing<br/>â€¢ Key rotation policy<br/>â€¢ Token expiry (15 min)"]
        end
    end

    subgraph DataLayer["ğŸ—„ï¸ Data Layer Attack Surface"]
        direction TB
        
        subgraph I2["ğŸ”“ DATA DISCLOSURE"]
            I2_1["I2.1 - Database Breach<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: SQL injection or<br/>direct DB access<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Parameterized queries<br/>â€¢ Encryption at rest (AES-256)<br/>â€¢ Network segmentation"]
            
            I2_2["I2.2 - Backup Exposure<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Unencrypted backups<br/>stolen or leaked<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Encrypted backups<br/>â€¢ Separate backup keys<br/>â€¢ Secure backup storage"]
            
            I2_3["I2.3 - Log Aggregation Leak<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: PHI appears in<br/>application logs<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ PHI scrubbing in logs<br/>â€¢ Log access controls<br/>â€¢ Retention limits"]
        end
        
        subgraph T2["âœï¸ DATA TAMPERING"]
            T2_1["T2.1 - Record Modification<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Alter historical<br/>mood/CBT records<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Append-only design<br/>â€¢ Version history<br/>â€¢ Cryptographic hashing"]
            
            T2_2["T2.2 - Audit Log Deletion<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Remove evidence<br/>of malicious activity<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Write-once audit storage<br/>â€¢ Off-site replication<br/>â€¢ Tamper-evident logging"]
        end
    end

    subgraph ClinicalSafety["ğŸ¥ Clinical Safety Attack Surface"]
        direction TB
        
        subgraph CS1["âš ï¸ SAFETY-CRITICAL THREATS"]
            CS1_1["CS1.1 - Emergency Suppression<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Block crisis indicators<br/>from reaching therapist<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Priority queue for safety<br/>â€¢ Redundant notification paths<br/>â€¢ Automated escalation (G17)"]
            
            CS1_2["CS1.2 - False Practitioner<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Attack: Unlicensed person<br/>provides clinical guidance<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Mitigation:<br/>â€¢ Credential verification (G16)<br/>â€¢ License expiry monitoring<br/>â€¢ Regulatory API integration"]
        end
    end

    %% Connections showing attack flow
    S1 --> TransportLayer
    T1 --> TransportLayer
    TransportLayer --> BackendLayer
    BackendLayer --> DataLayer
    BackendLayer --> ClinicalSafety

    %% Styling
    classDef spoofing fill:#dc3545,stroke:#a71d2a,stroke-width:2px,color:#fff
    classDef tampering fill:#fd7e14,stroke:#c96209,stroke-width:2px,color:#fff
    classDef repudiation fill:#6f42c1,stroke:#5a32a3,stroke-width:2px,color:#fff
    classDef disclosure fill:#0dcaf0,stroke:#0aa2c0,stroke-width:2px,color:#000
    classDef dos fill:#6c757d,stroke:#545b62,stroke-width:2px,color:#fff
    classDef elevation fill:#198754,stroke:#146c43,stroke-width:2px,color:#fff
    classDef clinical fill:#d63384,stroke:#ab296a,stroke-width:2px,color:#fff
    classDef legend fill:#f8f9fa,stroke:#dee2e6,stroke-width:1px

    class S1,S1_1,S1_2,S1_3 spoofing
    class T1,T1_1,T1_2,T1_3,T2,T2_1,T2_2 tampering
    class R1,R1_1,R1_2,R1_3 repudiation
    class I1,I1_1,I1_2,I1_3,I2,I2_1,I2_2,I2_3 disclosure
    class D1,D1_1,D1_2,D1_3 dos
    class E1,E1_1,E1_2,E1_3 elevation
    class CS1,CS1_1,CS1_2 clinical
    class Legend,S,T,R,I,D,E legend
