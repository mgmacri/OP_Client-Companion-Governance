%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4a90d9', 'primaryTextColor': '#fff', 'primaryBorderColor': '#2d6cb5', 'lineColor': '#5c6bc0', 'secondaryColor': '#81c784', 'tertiaryColor': '#fff3e0'}}}%%

flowchart TB
    subgraph UserInput["ğŸ“ 1. Client Data Entry"]
        direction TB
        
        User((ğŸ‘¤ Client))
        
        subgraph FormData["Form Payloads"]
            MoodData["ğŸ­ Mood Diary<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ mood_rating: 1-10<br/>â€¢ emotions: string[]<br/>â€¢ triggers: string<br/>â€¢ coping_used: string<br/>â€¢ notes: string<br/>â€¢ logged_at_local: ISO8601"]
            
            CBTData["ğŸ§  CBT Thought Record<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ situation: string<br/>â€¢ automatic_thought: string<br/>â€¢ emotions: {name, intensity}[]<br/>â€¢ evidence_for: string<br/>â€¢ evidence_against: string<br/>â€¢ balanced_thought: string<br/>â€¢ outcome_emotions: {name, intensity}[]"]
            
            SleepData["ğŸ˜´ Sleep Log<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ bedtime: ISO8601<br/>â€¢ wake_time: ISO8601<br/>â€¢ sleep_quality: 1-5<br/>â€¢ interruptions: number<br/>â€¢ notes: string"]
            
            GenericLog["ğŸ“‹ Other Log Types<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ log_type: LogTypeEnum<br/>â€¢ payload: JSON<br/>â€¢ schema_version: string"]
        end
        
        User -->|"fills out"| FormData
    end
    
    subgraph ConsentCapture["ğŸ”’ 2. Consent Gate"]
        direction TB
        
        ConsentModal["Consent Modal<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Display: Privacy notice<br/>+ Data usage terms"]
        
        ConsentPayload["ConsentRecord<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ client_id: UUID<br/>â€¢ consent_type: 'log_submission'<br/>â€¢ granted: boolean<br/>â€¢ granted_at_local: ISO8601<br/>â€¢ version: string"]
        
        ConsentModal -->|"user accepts"| ConsentPayload
    end
    
    FormData -->|"triggers"| ConsentModal
    
    subgraph ReduxState["ğŸ“Š 3. Redux State Management"]
        direction TB
        
        LogFormState["logFormSlice State<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ formData: FormPayload<br/>â€¢ isValid: boolean<br/>â€¢ validationErrors: string[]<br/>â€¢ consentGranted: boolean<br/>â€¢ submissionStatus: 'idle'|'pending'|'queued'|'synced'|'error'"]
        
        Actions["Redux Actions<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â†’ setFormField(field, value)<br/>â†’ validateForm()<br/>â†’ grantConsent(consentRecord)<br/>â†’ submitLog()<br/>â†’ queueLog(queueItem)<br/>â†’ syncSuccess(serverId)<br/>â†’ syncFailure(error)"]
        
        LogFormState <-->|"dispatch/select"| Actions
    end
    
    ConsentPayload -->|"dispatch grantConsent"| ReduxState
    
    subgraph QueueEntry["ğŸ“¦ 4. Queue Item Creation"]
        direction TB
        
        QueueItem["QueuedLogEntry<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ queue_id: UUID (client-gen)<br/>â€¢ client_id: UUID<br/>â€¢ log_type: LogTypeEnum<br/>â€¢ payload: FormPayload<br/>â€¢ consent_record: ConsentRecord<br/>â€¢ created_at_local: ISO8601<br/>â€¢ retry_count: 0<br/>â€¢ status: 'pending'"]
    end
    
    Actions -->|"submitLog()"| QueueItem
    
    subgraph OfflineStorage["ğŸ’¾ 5. Offline Encrypted Queue (IndexedDB)"]
        direction TB
        
        EncryptionProcess["ğŸ” Encryption Layer<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Algorithm: AES-256-GCM<br/>Key: Device-bound<br/>IV: Random per entry"]
        
        IDBStore["IndexedDB Store: 'logQueue'<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Key: queue_id<br/>Value: EncryptedBlob<br/>Index: status, created_at<br/>Max Items: 50"]
        
        QueueMetadata["Queue Metadata<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ total_pending: number<br/>â€¢ oldest_entry: ISO8601<br/>â€¢ last_sync_attempt: ISO8601"]
        
        QueueItem -->|"encrypt"| EncryptionProcess
        EncryptionProcess -->|"store"| IDBStore
        IDBStore -.->|"tracks"| QueueMetadata
    end
    
    subgraph SyncProcess["ğŸ”„ 6. Sync Saga Process"]
        direction TB
        
        ConnCheck["Connectivity Check<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>navigator.onLine<br/>+ heartbeat ping"]
        
        DecryptRead["Decrypt & Read<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Fetch pending items<br/>â€¢ Decrypt payloads<br/>â€¢ Order by created_at"]
        
        BackoffCalc["Retry Backoff<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>delay = min(1000 * 2^retry, 30000)<br/>max_retries: 5"]
        
        TransportPayload["HTTP Request Payload<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>POST /api/logs<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Headers:<br/>â€¢ Authorization: Bearer JWT<br/>â€¢ Content-Type: application/json<br/>â€¢ X-Client-Queue-ID: UUID<br/>â€¢ X-Idempotency-Key: UUID<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Body: QueuedLogEntry"]
        
        ConnCheck -->|"online"| DecryptRead
        ConnCheck -->|"offline"| BackoffCalc
        BackoffCalc -->|"retry"| ConnCheck
        DecryptRead --> TransportPayload
    end
    
    IDBStore -->|"saga watches"| SyncProcess
    
    subgraph APILayer["âš™ï¸ 7. Backend API Processing"]
        direction TB
        
        RequestValidation["Request Validation<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ JWT verification<br/>â€¢ Schema validation (AJV)<br/>â€¢ Idempotency check<br/>â€¢ Rate limiting"]
        
        ServerTimestamp["Server Timestamp<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>submitted_at_utc = NOW()<br/>(Server authoritative)"]
        
        LogTransform["Log Transformation<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>ClientLogEntry {<br/>  id: UUID (server-gen)<br/>  client_id: UUID<br/>  log_type: LogTypeEnum<br/>  payload: JSON<br/>  logged_at_local: ISO8601<br/>  submitted_at_utc: ISO8601<br/>  consent_id: UUID<br/>  schema_version: string<br/>  created_at: ISO8601<br/>}"]
        
        TransportPayload -->|"POST /api/logs"| RequestValidation
        RequestValidation -->|"valid"| ServerTimestamp
        ServerTimestamp --> LogTransform
    end
    
    subgraph DatabaseLayer["ğŸ—„ï¸ 8. SQL Database Storage"]
        direction TB
        
        ClientLogTable[("ClientLogEntry Table<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>PK: id (UUID)<br/>FK: client_id â†’ clients<br/>FK: consent_id â†’ consents<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Indexes:<br/>â€¢ client_id + log_type<br/>â€¢ submitted_at_utc<br/>â€¢ status")]
        
        ConsentTable[("ConsentRecord Table<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>PK: id (UUID)<br/>FK: client_id â†’ clients<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ consent_type<br/>â€¢ granted<br/>â€¢ granted_at_utc<br/>â€¢ version")]
        
        AuditTable[("AuditLog Table<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>PK: id (UUID)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ entity_type<br/>â€¢ entity_id<br/>â€¢ action<br/>â€¢ actor_id<br/>â€¢ timestamp_utc<br/>â€¢ changes_json")]
        
        LogTransform -->|"INSERT"| ClientLogTable
        LogTransform -->|"INSERT"| ConsentTable
        LogTransform -->|"INSERT audit"| AuditTable
    end
    
    subgraph NoteSynthesis["ğŸ“ 9. Deterministic Note Synthesis"]
        direction TB
        
        TemplateSelect["Template Selection<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Based on log_type:<br/>â€¢ mood_diary â†’ mood_template<br/>â€¢ cbt_record â†’ cbt_template<br/>â€¢ sleep_log â†’ sleep_template"]
        
        TemplateFill["Template Population<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>NO AI/ML inference<br/>Direct field mapping only<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>{{mood_rating}} â†’ payload.mood_rating<br/>{{emotions}} â†’ payload.emotions.join()<br/>{{date}} â†’ logged_at_local"]
        
        DraftNoteEntity["DraftNote Entity<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ id: UUID<br/>â€¢ client_id: UUID<br/>â€¢ source_log_ids: UUID[]<br/>â€¢ note_type: string<br/>â€¢ content: string<br/>â€¢ status: 'pending_review'<br/>â€¢ created_at_utc: ISO8601<br/>â€¢ therapist_id: null"]
        
        ClientLogTable -->|"trigger on insert"| TemplateSelect
        TemplateSelect --> TemplateFill
        TemplateFill --> DraftNoteEntity
    end
    
    subgraph DraftStorage["ğŸ“‹ 10. Draft Note Storage"]
        direction TB
        
        DraftNoteTable[("DraftNote Table<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>PK: id (UUID)<br/>FK: client_id â†’ clients<br/>FK: therapist_id â†’ users<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ status: pending_review |<br/>  approved | rejected<br/>â€¢ reviewed_at_utc<br/>â€¢ reviewer_notes")]
        
        DraftNoteEntity -->|"INSERT"| DraftNoteTable
    end
    
    subgraph APIResponse["ğŸ“¤ 11. API Response Flow"]
        direction TB
        
        SuccessResponse["Success Response<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>HTTP 201 Created<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>{<br/>  server_id: UUID,<br/>  submitted_at_utc: ISO8601,<br/>  queue_id: UUID (echo),<br/>  status: 'received'<br/>}"]
        
        ErrorResponse["Error Response<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>HTTP 4xx/5xx<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>{<br/>  error_code: string,<br/>  message: string,<br/>  retry_allowed: boolean,<br/>  queue_id: UUID<br/>}"]
    end
    
    ClientLogTable -->|"success"| SuccessResponse
    RequestValidation -->|"invalid"| ErrorResponse
    
    subgraph ClientSync["âœ… 12. Client Sync Completion"]
        direction TB
        
        UpdateQueue["Update Queue Entry<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>status: 'synced'<br/>server_id: response.server_id<br/>synced_at: NOW()"]
        
        CleanupQueue["Queue Cleanup<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Remove synced entries<br/>â€¢ Update retry count on error<br/>â€¢ Mark failed after max retries"]
        
        StateUpdate["Redux State Update<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â†’ syncSuccess(serverId)<br/>â†’ clearForm()<br/>â†’ showSuccessToast()"]
        
        SuccessResponse -->|"received"| UpdateQueue
        UpdateQueue --> CleanupQueue
        CleanupQueue --> StateUpdate
        
        ErrorResponse -->|"retryable"| BackoffCalc
        ErrorResponse -->|"non-retryable"| CleanupQueue
    end
    
    subgraph TherapistFlow["ğŸ‘¨â€âš•ï¸ 13. Therapist Review Flow"]
        direction TB
        
        Therapist((ğŸ‘¨â€âš•ï¸ Therapist))
        
        FetchPending["GET /api/draft-notes?status=pending_review<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Response: DraftNote[]<br/>+ associated ClientLogEntry[]"]
        
        ReviewUI["Review Interface<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ View draft content<br/>â€¢ View source logs<br/>â€¢ Edit draft text<br/>â€¢ Approve / Reject"]
        
        ApprovalPayload["Approval Request<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>PATCH /api/draft-notes/:id<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>{<br/>  status: 'approved',<br/>  final_content: string,<br/>  reviewer_notes: string<br/>}"]
        
        Therapist -->|"requests"| FetchPending
        DraftNoteTable -->|"query"| FetchPending
        FetchPending --> ReviewUI
        ReviewUI -->|"submits"| ApprovalPayload
        ApprovalPayload -->|"UPDATE"| DraftNoteTable
    end
    
    %% Data Type Legend
    subgraph Legend["ğŸ“š Data Type Legend"]
        direction LR
        L1["ğŸ”µ User Input"]
        L2["ğŸŸ¢ Processed Data"]
        L3["ğŸŸ  Queued Data"]
        L4["ğŸ”´ Stored Data"]
        L5["ğŸŸ£ API Payload"]
    end
    
    %% Styling
    classDef userInput fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef processed fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef queued fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef stored fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef apiPayload fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef legend fill:#fafafa,stroke:#9e9e9e,stroke-width:1px
    
    class UserInput,FormData userInput
    class ReduxState,NoteSynthesis processed
    class OfflineStorage,QueueEntry queued
    class DatabaseLayer,DraftStorage stored
    class APILayer,APIResponse,SyncProcess apiPayload
    class Legend legend
